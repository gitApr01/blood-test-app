import React, {useEffect, useState} from 'react'
import { get, put } from '../api.js'
export default function Reports(){ const [month,setMonth]=useState(new Date().toISOString().slice(0,7)); const [data,setData]=useState([]); useEffect(()=>{ load() },[month]); async function load(){ try{ const all = await get('/all_tests'); const filtered = all.filter(x=> (x.created_at||x.date||'').slice(0,7)===month); const map={}; filtered.forEach(e=>{ const c = e.collected_by||'Unknown'; if(!map[c]) map[c]={collectedBy:c,total:0,adminShare:0,entries:[]}; map[c].total += Number(e.total||0); map[c].adminShare += Number(((e.total||0)*0.4).toFixed(2)); map[c].entries.push(e); }); const arr = Object.values(map); arr.forEach(a=>{ a.commissionPaid = 0; a.commissionDue = a.adminShare - a.commissionPaid; }); setData(arr); }catch(e){console.error(e)} } async function saveCommission(collectedBy,paid){ try{ await put('/update_commission',{collectedBy, paid}); alert('Saved (demo)') }catch(e){console.error(e)} } return (<div><div className='card'><h2 className='h2'>Reports</h2><div style={{display:'flex',gap:8,alignItems:'center'}}><input type='month' className='input' value={month} onChange={e=>setMonth(e.target.value)}/><button className='btn' onClick={load}>Refresh</button></div></div><div className='card'>{data.length===0? <div className='muted'>No data</div> : data.map((d,idx)=> (<div key={d.collectedBy} style={{display:'flex',justifyContent:'space-between',padding:10,borderBottom:'1px dashed #eef2f7'}}><div><div style={{fontWeight:700}}>{d.collectedBy}</div><div className='muted small'>Total: ₹{d.total.toFixed(2)}</div><div className='muted small'>Admin Share (40%): ₹{d.adminShare.toFixed(2)}</div></div><div style={{display:'flex',gap:8,alignItems:'center'}}><input className='input' style={{width:140}} type='number' defaultValue={d.commissionPaid} onBlur={e=>saveCommission(d.collectedBy, Number(e.target.value)||0)}/><div className='small muted'>Due: ₹{(d.commissionDue||0).toFixed(2)}</div></div></div>))}</div></div>) }
